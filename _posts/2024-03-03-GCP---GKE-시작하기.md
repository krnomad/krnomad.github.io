---
layout: post
date: 2024-03-03
title: "GCP - GKE ì‹œì‘í•˜ê¸°"
tags: [GCP, GKE, ]
categories: [cloud, ]
pin: true
---


# Overview


GCPë¥¼ ì´ìš©í•˜ë©´ ê°„ë‹¨íˆ Kuberenetes clusterë¥¼ êµ¬ì¶•í•˜ê³  ì´ë¥¼ í†µí•´ cloudë¥¼ ì‰½ê²Œ í™œìš”í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•˜ë‹¤. ì´í•˜ì—ì„œëŠ” GCPë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ë³¸ í™˜ê²½ ì„¤ì • ë° GKE(google kubernetes engine)ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ë„ë¡ í•˜ê² ë‹¤.


ì „ë°˜ì ì¸ ê³¼ì •ì€ ë‹¤ìŒê³¼ ê°™ë‹¤. ìš°ì„  GCPë¥¼ CLIí™˜ê²½ì—ì„œ ì„¤ì •í•  ìˆ˜ ìˆë„ë¡ gcloudë¥¼ ì„¤ì¹˜í•˜ê³ , ì´í›„ gcloud ë˜ëŠ” web UIë¡œ kubernetes clusterë¥¼ ë°°í¬í•œë‹¤.


ë‹¤ìŒìœ¼ë¡œ locoal í™˜ê²½ì—ì„œ kubectlì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ì„¤ì •í•œë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ bation VMì„ ì„¤ì •í•´ bastion VMì„ í†µí•´ í•­ìƒ ê°™ì€ í™˜ê²½ì—ì„œ kubectlì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë§Œë“ ë‹¤.


ë§Œì•½ GKEë¥¼ ë‹¤ë¥¸ accountë¡œ ì¬ì„¤ì • í–ˆì„ ê²½ìš° ê°€ì¥ í•˜ë‹¨ì— â€œ[**GKE ë§Œë£Œ í›„ ë‹¤ì‹œ cloud ì„¤ì •í•˜ê¸°**](/ee3e2ddb8d984897bf4e5067bb2ea642)â€ë¥¼ ì°¸ì¡°í•˜ë©´ ëœë‹¤.  


> ğŸ’¡ GCP region ì •ë³´  
> asia-northeast3-a ì´ seoul regionì´ë‹¤.


# gcloud ì„¤ì¹˜


## gcloud ì„¤ì¹˜ (ìœˆë„ìš°)


ìœˆë„ìš°ì—ì„œ powershellì„ í†µí•´ ì†ì‰½ê²Œ gcloudë¥¼ ì„¤ì¹˜í•  ìˆ˜ ìˆë‹¤. gcloudëŠ” python 3.8+ ë¶€í„° ì„¤ì •ì´ ê°€ëŠ¥í•œë°, SDKInstnsallterì— pythonì´ ìë™ìœ¼ë¡œ í¬í•¨ë¼ ì„¤ì¹˜ëœë‹¤. 


ì„¤ì¹˜ê°€ ì™„ë£Œë˜ë©´ gcloud ëª…ë ¹ì„ consoleì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ëœë‹¤. 


{% raw %}
```bash
(New-Object Net.WebClient).DownloadFile("https://dl.google.com/dl/cloudsdk/channels/rapid/GoogleCloudSDKInstaller.exe", "$env:Temp\GoogleCloudSDKInstaller.exe")

& $env:Temp\GoogleCloudSDKInstaller.exe
```
{% endraw %}


**plugin ì„¤ì¹˜**


window í™˜ê²½ì—ì„œ GKEë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë‹¤ìŒ plguinì´ ì„¤ì¹˜ë¼ì•¼ í•œë‹¤.


{% raw %}
```bash
gcloud components install gke-gcloud-auth-plugin
```
{% endraw %}


## gcloud ì„¤ì¹˜ (ë¦¬ëˆ…ìŠ¤ - ìš°ë¶„íˆ¬ 20.04 ê¸°ì¤€)


[https://cloud.google.com/sdk/docs/install?hl=ko](https://cloud.google.com/sdk/docs/install?hl=ko)


**package ì„¤ì¹˜**


{% raw %}
```bash
sudo apt-get update
sudo apt-get install apt-transport-https ca-certificates gnupg curl sudo
curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
sudo apt-get update && sudo apt-get install google-cloud-cli
```
{% endraw %}


plugin ì„¤ì¹˜


{% raw %}
```bash
sudo apt-get install google-cloud-cli-gke-gcloud-auth-plugin
```
{% endraw %}


**gcloud ê¸°ë³¸ ì„¤ì •**


{% raw %}
```bash
gcloud init
```
{% endraw %}


### Kubectl ì„¤ì¹˜í•˜ê¸°


{% raw %}
```dart
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod 775 kubectl
sudo mv kubectl /usr/local/bin/
```
{% endraw %}


[https://kubernetes.io/ko/docs/tasks/tools/install-kubectl-linux/](https://kubernetes.io/ko/docs/tasks/tools/install-kubectl-linux/)


ìœˆë„ìš°ë‚˜ ë§¥ í™˜ê²½ì—ì„œ kubectlì€ ë‹¤ìŒì„ ì°¸ì¡°í•˜ì


window: [https://kubernetes.io/ko/docs/tasks/tools/install-kubectl-windows/](https://kubernetes.io/ko/docs/tasks/tools/install-kubectl-windows/)


mac: [https://kubernetes.io/ko/docs/tasks/tools/install-kubectl-macos/](https://kubernetes.io/ko/docs/tasks/tools/install-kubectl-macos/)


# GKE ì„¤ì¹˜


GCPì—ì„œ ì œê³µí•˜ëŠ” ë¬´ë£Œ creditì„ ê°€ì§€ê³  GKE(Google Kubernetes Engine)ì„ ì‹¤ìŠµ í•  ìˆ˜ ìˆë‹¤.


## Web UIë¥¼ í†µí•´ kubernetes cluster ë°°í¬í•˜ê¸° (ë§¤ìš° ê°„ë‹¨)


GCP consoleì— ë“¤ì–´ê°€ì„œ Kubernetes Engine ë©”ë‰´ë¡œ ë“¤ì–´ê°€ enableì„ ìˆ˜í–‰í•œ ë’¤, Web UI ë©”ë‰´ë¥¼ í†µí•´ Kubernetes clusterë¥¼ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.


![0](/assets/img/2024-03-03-GCP---GKE-ì‹œì‘í•˜ê¸°.md/0.png)


![1](/assets/img/2024-03-03-GCP---GKE-ì‹œì‘í•˜ê¸°.md/1.png)


ì´í›„ UIì—ì„œ ì œê³µí•˜ëŠ” ì—°ê²° ë²„íŠ¼ì„ í´ë¦­í•´ ëª…ë ¹ì¤„ ì—‘ì„¸ìŠ¤ë¥¼ ì°¸ì¡°í•˜ë©´ kube configê°€ ìë™ìœ¼ë¡œ ì„¤ì •ëœë‹¤. (.kube/config) 


![2](/assets/img/2024-03-03-GCP---GKE-ì‹œì‘í•˜ê¸°.md/2.png)


{% raw %}
```bash
gcloud container clusters get-credentials core-kubernetes --zone asia-northeast3-a --project secret-imprint-412501
```
{% endraw %}


ì´í›„ powershell í™˜ê²½ì—ì„œ kubectlì„ í†µí•´ GKEì„ control í•  ìˆ˜ ìˆë‹¤. 


## CLIí™˜ê²½ì—ì„œ gcloudë¥¼ í†µí•´ kubernetes cluster ë°°í¬í•˜ê¸° (ì¶”ì²œ)


CLIëª…ë ¹ì„ í†µí•´ UIë³´ë‹¤ ë” ì§ê´€ì ì´ê³  í¸ë¦¬í•˜ê²Œ k8s clusterë¥¼ êµ¬ì¶•í•  ìˆ˜ ìˆë‹¤.


í´ëŸ¬ìŠ¤í„° ìƒì„±í•˜ê¸°


{% raw %}
```bash
CLUSTER_NAME=core-kubernetes
REGION=asia-northeast3-a

gcloud components update
gcloud config set compute/zone $REGION

gcloud container clusters create $CLUSTER_NAME \
    --enable-autoscaling \
    --min-nodes=1 \
    --num-nodes=1 \
    --max-nodes=3 \
    --node-locations=$REGION \
    --machine-type=n1-standard-4

# í´ëŸ¬ìŠ¤í„° í™•ì¸
kubectl get node
# NAME                                             STATUS   ROLES    AGE     VERSION# gke-core-kubernetes-default-pool-b5dfd3f2-4f84   Ready    <none>   6m38s   v1.15.12-gke.2
```
{% endraw %}


ì´í›„ Compute Engineì— ë“¤ì–´ê°€ë©´ node poolì´ ì¶”ê°€ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![3](/assets/img/2024-03-03-GCP---GKE-ì‹œì‘í•˜ê¸°.md/3.png)


---


## Bastion VM ìƒì„±

- usage
undefined- example
undefined
bastion vm ìƒì„±í•˜ë©´ ìƒˆë¡œìš´ service accountê°€ ìë™ ìƒì„±ë˜ëŠ”ë°, í•´ë‹¹ SAì—ëŠ” GKEì™€ ì—°ê²°í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì´ ë¶€ì—¬ë¼ ìˆì§€ ì•Šë‹¤. ê·¸ëŸ¬ë¯€ë¡œ gcloud initì—ì„œ new configurationìœ¼ë¡œ ê¸°ì¡´ browerì— login ë¼ ìˆëŠ” accountì˜ ê¶Œí•œì´ ì‚¬ìš©ë  ìˆ˜ ìˆê²Œ ì„¤ì •í•œë‹¤. 


# (ì°¸ê³ ) Service account ìƒì„± ë° ê¶Œí•œ ë¶€ì—¬ with gcloud


### Service account ë§Œë“¤ê¸°

- usage: `gcloud iam service-accounts create` **`SERVICE_ACCOUNT_NAME`**
- example: `gcloud iam service-accounts create krnomad-adm`

### Service accountì— role ë¶€ì—¬í•˜ê¸° 

- usage
undefined- example
undefined
## Trouble shooting


### bastion VM Service accont role binding ì´ìŠˆ (WIP)


bastion vm ìƒì„± ì‹œ ì—°ê²°ëœ service accountëŠ” GKE ê¶Œí•œì´ ì—†ê¸° ë•Œë¬¸ì— ë³„ë„ SAë¥¼ ìƒì„±í•˜ê³  ê¶Œí•œì„ ë¶€ì—¬í•œ í›„ gcloud configurationì„ ë³€ê²½í•´ì¤˜ì•¼ í•œë‹¤.


> ğŸ’¡ gcpì—ì„œ bastion vmì„ êµ¬ì„±í•˜ê³  GKEë¥¼ ì‚¬ìš©í•˜ë ¤ê³  í•œë‹¤. bastion vmì€ ìƒì„±ëì§€ë§Œ gcloudì— ì—°ê²°ë˜ service account ê³„ì •ì— ê¶Œí•œì´ ì—†ì–´ `gcloud container clusters get-credentials` ëª…ë ¹ ì‹¤í–‰ì‹œ ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤.  
> bastion vmì— binding ë¼ ìˆëŠ” SAì— ê¶Œí•œì„ ë¶€ì—¬í•˜ê±°ë‚˜ bastion vmì´ ë‹¤ë¥¸ SAë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½í•´ì•¼í•  ê²ƒ ê°™ì€ë°, ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ?


{% raw %}
```dart
gcloud projects add-iam-policy-binding  white-rune-415922 --member="serviceAccount:234721658196-compute@developer.gserviceaccount.com" --role="roles/owner"
```
{% endraw %}


{% raw %}
```dart
gcloud projects add-iam-policy-binding  white-rune-415922 --member="serviceAccount:234721658196-compute@developer.gserviceaccount.com" --role=roles/container.developer
```
{% endraw %}


# GKE ë§Œë£Œ í›„ ë‹¤ì‹œ cloud ì„¤ì •í•˜ê¸° (WIP)


ë¬´ë£Œ creditì´ ì¢…ë£Œë¼ ë‹¤ì‹œ ì„¤ì •ì´ í•„ìš”í•  ê²½ìš°, ë‹¤ìŒ ìˆœì„œë¡œ GKEë¥¼ ì¬ì„¤ì • í•  ìˆ˜ ìˆë‹¤.

1. ì‹ ê·œ google id ìƒì„±
2. GCP ê°€ì… ë° ë¬´ë£Œ credit ë°›ê¸°
3. gcloud init
